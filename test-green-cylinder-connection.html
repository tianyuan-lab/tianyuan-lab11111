<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ³è†æ—‹æµå™¨ - ç»¿è‰²å°åœ†æŸ±è¿æ¥æµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
            z-index: 100;
        }
        
        .status {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .highlight {
            color: #00ff00;
            font-weight: bold;
        }
        
        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 100;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div class="info-panel">
        <h3>ğŸ” ç»¿è‰²å°åœ†æŸ±è¿æ¥æµ‹è¯•</h3>
        <div class="status">çŠ¶æ€: <span id="status">åˆå§‹åŒ–ä¸­...</span></div>
        <div class="status">ç»¿è‰²é”¥ä½“: <span id="cone-count">0</span> ä¸ª</div>
        <div class="status">ç»¿è‰²å°åœ†æŸ±: <span id="cylinder-count">0</span> ä¸ª</div>
        <div class="status">è“è‰²è½¯ç®¡: <span id="hose-count">0</span> ä¸ª</div>
        <div class="status highlight">è¿æ¥æ–¹å¼: ç»¿è‰²é”¥ä½“ â†’ ç»¿è‰²å°åœ†æŸ± â†’ è“è‰²è½¯ç®¡ â†’ ç™½è‰²é›†æµå™¨</div>
    </div>

    <div class="controls">
        <button onclick="validateConnections()">ğŸ” éªŒè¯è¿æ¥</button>
        <button onclick="showCoordinates()">ğŸ“ æ˜¾ç¤ºåæ ‡</button>
        <button onclick="resetView()">ğŸ¯ é‡ç½®è§†è§’</button>
    </div>

    <div id="canvas-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="js/GypsumCyclone.js"></script>

    <script>
        let scene, camera, renderer, controls;
        let gypsumCyclone;

        function init() {
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);

            // åˆ›å»ºç›¸æœº
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(15, 10, 15);

            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // åˆ›å»ºæ§åˆ¶å™¨
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.target.set(0, 5, 0);

            // æ·»åŠ ç¯å…‰
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(10, 20, 10);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);

            // æ·»åŠ ç‚¹å…‰æºç…§äº®ç»¿è‰²å°åœ†æŸ±
            const spotLight = new THREE.SpotLight(0xffffff, 0.8);
            spotLight.position.set(0, 15, 0);
            spotLight.target.position.set(0, 3, 0);
            spotLight.castShadow = true;
            scene.add(spotLight);
            scene.add(spotLight.target);

            // åˆ›å»ºåœ°é¢
            const groundGeometry = new THREE.PlaneGeometry(50, 50);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x90EE90 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            updateStatus('æ­£åœ¨åˆ›å»ºçŸ³è†æ—‹æµå™¨...');

            // åˆ›å»ºçŸ³è†æ—‹æµå™¨
            gypsumCyclone = new GypsumCyclone({ x: 0, y: 0, z: 0 });
            scene.add(gypsumCyclone.getGroup());

            updateStatus('çŸ³è†æ—‹æµå™¨åˆ›å»ºå®Œæˆ');
            updateCounts();

            // å¼€å§‹æ¸²æŸ“å¾ªç¯
            animate();

            // å»¶è¿ŸéªŒè¯è¿æ¥
            setTimeout(() => {
                validateConnections();
                showDetailedInfo();
            }, 1000);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function updateCounts() {
            if (gypsumCyclone && gypsumCyclone.components) {
                const coneCount = gypsumCyclone.components.cyclones ? 
                    gypsumCyclone.components.cyclones.children.length : 0;
                const hoseCount = gypsumCyclone.components.hoses ? 
                    gypsumCyclone.components.hoses.children.length : 0;
                
                document.getElementById('cone-count').textContent = coneCount;
                document.getElementById('hose-count').textContent = hoseCount;
                
                // è®¡ç®—ç»¿è‰²å°åœ†æŸ±æ•°é‡
                let cylinderCount = 0;
                if (gypsumCyclone.components.hoses) {
                    gypsumCyclone.components.hoses.children.forEach(hoseGroup => {
                        hoseGroup.children.forEach(child => {
                            if (child.name && child.name.includes('ç»¿è‰²è¿æ¥å™¨')) {
                                cylinderCount++;
                            }
                        });
                    });
                }
                document.getElementById('cylinder-count').textContent = cylinderCount;
            }
        }

        function validateConnections() {
            if (gypsumCyclone && gypsumCyclone.validateAlignment) {
                console.group('ğŸ” æ‰‹åŠ¨éªŒè¯è¿æ¥');
                const result = gypsumCyclone.validateAlignment();
                if (result) {
                    updateStatus('âœ… æ‰€æœ‰è¿æ¥éªŒè¯é€šè¿‡');
                } else {
                    updateStatus('âŒ è¿æ¥éªŒè¯å¤±è´¥');
                }
                console.groupEnd();
            }
        }

        function showCoordinates() {
            if (gypsumCyclone) {
                console.group('ğŸ“ åæ ‡ä¿¡æ¯');
                
                // æ˜¾ç¤ºç»¿è‰²å°åœ†æŸ±åæ ‡
                const greenCylinders = gypsumCyclone.getGreenCylinderCoordinates();
                console.log('ç»¿è‰²å°åœ†æŸ±åæ ‡:');
                greenCylinders.forEach((coord, index) => {
                    console.log(`  ${index + 1}. (${coord.x.toFixed(3)}, ${coord.y.toFixed(3)}, ${coord.z.toFixed(3)})`);
                });
                
                // æ˜¾ç¤ºè½¯ç®¡åº•éƒ¨åæ ‡
                const hoseBottoms = gypsumCyclone.getHoseBottomCoordinates();
                console.log('è“è‰²è½¯ç®¡åº•éƒ¨åæ ‡:');
                hoseBottoms.forEach((coord, index) => {
                    console.log(`  ${index + 1}. (${coord.x.toFixed(3)}, ${coord.y.toFixed(3)}, ${coord.z.toFixed(3)})`);
                });
                
                console.groupEnd();
            }
        }

        function showDetailedInfo() {
            console.group('ğŸ¯ è¯¦ç»†è¿æ¥ä¿¡æ¯');
            
            if (gypsumCyclone && gypsumCyclone.components) {
                // åˆ†ææ¯ä¸ªç»„ä»¶
                const cyclones = gypsumCyclone.components.cyclones;
                const hoses = gypsumCyclone.components.hoses;
                
                console.log('=== ç»¿è‰²é”¥ä½“åˆ†æ ===');
                if (cyclones) {
                    cyclones.children.forEach((cone, index) => {
                        const pos = cone.position;
                        const userData = cone.userData;
                        console.log(`é”¥ä½“${index + 1}: ä½ç½®(${pos.x.toFixed(3)}, ${pos.y.toFixed(3)}, ${pos.z.toFixed(3)})`);
                        if (userData.greenCylinderConnectionCoord) {
                            const coord = userData.greenCylinderConnectionCoord;
                            console.log(`  â†’ è¿æ¥ç›®æ ‡: (${coord.x.toFixed(3)}, ${coord.y.toFixed(3)}, ${coord.z.toFixed(3)})`);
                        }
                    });
                }

                console.log('=== ç»¿è‰²å°åœ†æŸ±åˆ†æ ===');
                if (hoses) {
                    hoses.children.forEach((hoseGroup, index) => {
                        hoseGroup.children.forEach(child => {
                            if (child.name && child.name.includes('ç»¿è‰²è¿æ¥å™¨')) {
                                const pos = child.position;
                                console.log(`ç»¿è‰²è¿æ¥å™¨${index + 1}: ä½ç½®(${pos.x.toFixed(3)}, ${pos.y.toFixed(3)}, ${pos.z.toFixed(3)})`);
                            }
                        });
                    });
                }
            }
            
            console.groupEnd();
        }

        function resetView() {
            camera.position.set(15, 10, 15);
            controls.target.set(0, 5, 0);
            controls.update();
        }

        // çª—å£å¤§å°è°ƒæ•´
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // å¯åŠ¨
        init();
    </script>
</body>
</html>
