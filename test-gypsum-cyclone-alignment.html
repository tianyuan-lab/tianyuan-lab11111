<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>石膏旋流器对齐测试 - 蓝色软管与绿色锥体连接验证</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            max-width: 400px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .control-btn {
            background: rgba(0, 150, 255, 0.8);
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: rgba(0, 150, 255, 1);
            transform: translateY(-2px);
        }
        
        #coordinates-display {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            max-width: 600px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .coordinate-item {
            margin: 5px 0;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .alignment-status {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
        }
        
        .status-ok {
            color: #4CAF50;
        }
        
        .status-error {
            color: #F44336;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="info-panel">
            <h3>🔧 石膏旋流器对齐测试</h3>
            <p><strong>测试目标：</strong>验证八个绿色锥体底部与八个蓝色软管底部的精确对齐</p>
            <p><strong>操作说明：</strong></p>
            <ul>
                <li>🖱️ 左键拖拽：旋转视角</li>
                <li>🔄 滚轮：缩放视图</li>
                <li>📊 点击按钮：查看详细信息</li>
            </ul>
            <div id="loading">正在加载石膏旋流器模型...</div>
        </div>
        
        <div id="controls">
            <button class="control-btn" onclick="showCoordinates()">📍 显示坐标</button>
            <button class="control-btn" onclick="validateAlignment()">✅ 验证对齐</button>
            <button class="control-btn" onclick="toggleWireframe()">📐 线框模式</button>
            <button class="control-btn" onclick="resetView()">🔄 重置视角</button>
        </div>
        
        <div id="coordinates-display" style="display: none;">
            <h4>📍 八个蓝色软管底部坐标</h4>
            <div id="coordinate-list"></div>
        </div>
        
        <div id="alignment-status" style="display: none;">
            <h4>🔍 对齐验证结果</h4>
            <div id="alignment-result"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="js/GypsumCyclone.js"></script>
    
    <script>
        // 全局变量
        let scene, camera, renderer, controls;
        let gypsumCyclone;
        let isWireframe = false;
        
        /**
         * 初始化3D场景
         */
        function init() {
            // 创建场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            
            // 创建相机
            camera = new THREE.PerspectiveCamera(
                75, 
                window.innerWidth / window.innerHeight, 
                0.1, 
                1000
            );
            camera.position.set(8, 6, 8);
            
            // 创建渲染器
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            document.getElementById('container').appendChild(renderer.domElement);
            
            // 创建控制器
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 2;
            controls.maxDistance = 50;
            
            // 创建光照
            setupLighting();
            
            // 创建石膏旋流器
            createGypsumCyclone();
            
            // 创建地面
            createGround();
            
            // 开始渲染循环
            animate();
            
            // 窗口大小调整
            window.addEventListener('resize', onWindowResize, false);
            
            // 隐藏加载提示
            document.getElementById('loading').textContent = '✅ 模型加载完成';
        }
        
        /**
         * 设置光照系统
         */
        function setupLighting() {
            // 环境光
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);
            
            // 主光源
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // 补充光源
            const fillLight = new THREE.DirectionalLight(0x87CEEB, 0.3);
            fillLight.position.set(-5, 5, -5);
            scene.add(fillLight);
        }
        
        /**
         * 创建石膏旋流器
         */
        function createGypsumCyclone() {
            gypsumCyclone = new GypsumCyclone(
                { x: 0, y: 0, z: 0 }, 
                { x: 0, y: 0, z: 0 }
            );
            scene.add(gypsumCyclone.getGroup());
            
            console.log('石膏旋流器创建完成');
        }
        
        /**
         * 创建地面
         */
        function createGround() {
            const groundGeometry = new THREE.PlaneGeometry(50, 50);
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x333333,
                transparent: true,
                opacity: 0.5
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.1;
            ground.receiveShadow = true;
            scene.add(ground);
        }
        
        /**
         * 显示坐标信息
         */
        function showCoordinates() {
            if (!gypsumCyclone) return;
            
            const coordinatesDisplay = document.getElementById('coordinates-display');
            const coordinateList = document.getElementById('coordinate-list');
            
            coordinatesDisplay.style.display = 'block';
            
            const coordinates = gypsumCyclone.getHoseBottomCoordinates();
            if (coordinates.length === 0) {
                coordinateList.innerHTML = '<div class="coordinate-item">⚠️ 坐标数据未初始化</div>';
                return;
            }
            
            let html = '';
            coordinates.forEach((coord, index) => {
                html += `
                    <div class="coordinate-item">
                        软管${index + 1}: 角度${coord.angle.toFixed(1)}°<br>
                        坐标: (${coord.x.toFixed(3)}, ${coord.y.toFixed(3)}, ${coord.z.toFixed(3)})
                    </div>
                `;
            });
            
            coordinateList.innerHTML = html;
        }
        
        /**
         * 验证对齐情况
         */
        function validateAlignment() {
            if (!gypsumCyclone) return;
            
            const alignmentStatus = document.getElementById('alignment-status');
            const alignmentResult = document.getElementById('alignment-result');
            
            alignmentStatus.style.display = 'block';
            
            const isAligned = gypsumCyclone.validateAlignment();
            
            if (isAligned) {
                alignmentResult.innerHTML = `
                    <div class="status-ok">
                        ✅ 所有绿色锥体与蓝色软管底部完美对齐！<br>
                        <small>容差范围: ±1mm</small>
                    </div>
                `;
            } else {
                alignmentResult.innerHTML = `
                    <div class="status-error">
                        ❌ 发现对齐误差<br>
                        <small>请检查控制台详细信息</small>
                    </div>
                `;
            }
        }
        
        /**
         * 切换线框模式
         */
        function toggleWireframe() {
            if (!gypsumCyclone) return;
            
            isWireframe = !isWireframe;
            
            gypsumCyclone.getGroup().traverse((child) => {
                if (child.isMesh) {
                    child.material.wireframe = isWireframe;
                }
            });
        }
        
        /**
         * 重置视角
         */
        function resetView() {
            camera.position.set(8, 6, 8);
            controls.target.set(0, 2, 0);
            controls.update();
        }
        
        /**
         * 窗口大小调整
         */
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        /**
         * 渲染循环
         */
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        // 初始化
        init();
    </script>
</body>
</html>
