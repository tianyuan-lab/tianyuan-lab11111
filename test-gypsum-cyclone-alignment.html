<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ³è†æ—‹æµå™¨å¯¹é½æµ‹è¯• - è“è‰²è½¯ç®¡ä¸ç»¿è‰²é”¥ä½“è¿æ¥éªŒè¯</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            max-width: 400px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .control-btn {
            background: rgba(0, 150, 255, 0.8);
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: rgba(0, 150, 255, 1);
            transform: translateY(-2px);
        }
        
        #coordinates-display {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            max-width: 600px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .coordinate-item {
            margin: 5px 0;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .alignment-status {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
        }
        
        .status-ok {
            color: #4CAF50;
        }
        
        .status-error {
            color: #F44336;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="info-panel">
            <h3>ğŸ”§ çŸ³è†æ—‹æµå™¨å¯¹é½æµ‹è¯•</h3>
            <p><strong>æµ‹è¯•ç›®æ ‡ï¼š</strong>éªŒè¯å…«ä¸ªç»¿è‰²é”¥ä½“åº•éƒ¨ä¸å…«ä¸ªè“è‰²è½¯ç®¡åº•éƒ¨çš„ç²¾ç¡®å¯¹é½</p>
            <p><strong>æ“ä½œè¯´æ˜ï¼š</strong></p>
            <ul>
                <li>ğŸ–±ï¸ å·¦é”®æ‹–æ‹½ï¼šæ—‹è½¬è§†è§’</li>
                <li>ğŸ”„ æ»šè½®ï¼šç¼©æ”¾è§†å›¾</li>
                <li>ğŸ“Š ç‚¹å‡»æŒ‰é’®ï¼šæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</li>
            </ul>
            <div id="loading">æ­£åœ¨åŠ è½½çŸ³è†æ—‹æµå™¨æ¨¡å‹...</div>
        </div>
        
        <div id="controls">
            <button class="control-btn" onclick="showCoordinates()">ğŸ“ æ˜¾ç¤ºåæ ‡</button>
            <button class="control-btn" onclick="validateAlignment()">âœ… éªŒè¯å¯¹é½</button>
            <button class="control-btn" onclick="toggleWireframe()">ğŸ“ çº¿æ¡†æ¨¡å¼</button>
            <button class="control-btn" onclick="resetView()">ğŸ”„ é‡ç½®è§†è§’</button>
        </div>
        
        <div id="coordinates-display" style="display: none;">
            <h4>ğŸ“ å…«ä¸ªè“è‰²è½¯ç®¡åº•éƒ¨åæ ‡</h4>
            <div id="coordinate-list"></div>
        </div>
        
        <div id="alignment-status" style="display: none;">
            <h4>ğŸ” å¯¹é½éªŒè¯ç»“æœ</h4>
            <div id="alignment-result"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="js/GypsumCyclone.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let scene, camera, renderer, controls;
        let gypsumCyclone;
        let isWireframe = false;
        
        /**
         * åˆå§‹åŒ–3Dåœºæ™¯
         */
        function init() {
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            
            // åˆ›å»ºç›¸æœº
            camera = new THREE.PerspectiveCamera(
                75, 
                window.innerWidth / window.innerHeight, 
                0.1, 
                1000
            );
            camera.position.set(8, 6, 8);
            
            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            document.getElementById('container').appendChild(renderer.domElement);
            
            // åˆ›å»ºæ§åˆ¶å™¨
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 2;
            controls.maxDistance = 50;
            
            // åˆ›å»ºå…‰ç…§
            setupLighting();
            
            // åˆ›å»ºçŸ³è†æ—‹æµå™¨
            createGypsumCyclone();
            
            // åˆ›å»ºåœ°é¢
            createGround();
            
            // å¼€å§‹æ¸²æŸ“å¾ªç¯
            animate();
            
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', onWindowResize, false);
            
            // éšè—åŠ è½½æç¤º
            document.getElementById('loading').textContent = 'âœ… æ¨¡å‹åŠ è½½å®Œæˆ';
        }
        
        /**
         * è®¾ç½®å…‰ç…§ç³»ç»Ÿ
         */
        function setupLighting() {
            // ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);
            
            // ä¸»å…‰æº
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // è¡¥å……å…‰æº
            const fillLight = new THREE.DirectionalLight(0x87CEEB, 0.3);
            fillLight.position.set(-5, 5, -5);
            scene.add(fillLight);
        }
        
        /**
         * åˆ›å»ºçŸ³è†æ—‹æµå™¨
         */
        function createGypsumCyclone() {
            gypsumCyclone = new GypsumCyclone(
                { x: 0, y: 0, z: 0 }, 
                { x: 0, y: 0, z: 0 }
            );
            scene.add(gypsumCyclone.getGroup());
            
            console.log('çŸ³è†æ—‹æµå™¨åˆ›å»ºå®Œæˆ');
        }
        
        /**
         * åˆ›å»ºåœ°é¢
         */
        function createGround() {
            const groundGeometry = new THREE.PlaneGeometry(50, 50);
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x333333,
                transparent: true,
                opacity: 0.5
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.1;
            ground.receiveShadow = true;
            scene.add(ground);
        }
        
        /**
         * æ˜¾ç¤ºåæ ‡ä¿¡æ¯
         */
        function showCoordinates() {
            if (!gypsumCyclone) return;
            
            const coordinatesDisplay = document.getElementById('coordinates-display');
            const coordinateList = document.getElementById('coordinate-list');
            
            coordinatesDisplay.style.display = 'block';
            
            const coordinates = gypsumCyclone.getHoseBottomCoordinates();
            if (coordinates.length === 0) {
                coordinateList.innerHTML = '<div class="coordinate-item">âš ï¸ åæ ‡æ•°æ®æœªåˆå§‹åŒ–</div>';
                return;
            }
            
            let html = '';
            coordinates.forEach((coord, index) => {
                html += `
                    <div class="coordinate-item">
                        è½¯ç®¡${index + 1}: è§’åº¦${coord.angle.toFixed(1)}Â°<br>
                        åæ ‡: (${coord.x.toFixed(3)}, ${coord.y.toFixed(3)}, ${coord.z.toFixed(3)})
                    </div>
                `;
            });
            
            coordinateList.innerHTML = html;
        }
        
        /**
         * éªŒè¯å¯¹é½æƒ…å†µ
         */
        function validateAlignment() {
            if (!gypsumCyclone) return;
            
            const alignmentStatus = document.getElementById('alignment-status');
            const alignmentResult = document.getElementById('alignment-result');
            
            alignmentStatus.style.display = 'block';
            
            const isAligned = gypsumCyclone.validateAlignment();
            
            if (isAligned) {
                alignmentResult.innerHTML = `
                    <div class="status-ok">
                        âœ… æ‰€æœ‰ç»¿è‰²é”¥ä½“ä¸è“è‰²è½¯ç®¡åº•éƒ¨å®Œç¾å¯¹é½ï¼<br>
                        <small>å®¹å·®èŒƒå›´: Â±1mm</small>
                    </div>
                `;
            } else {
                alignmentResult.innerHTML = `
                    <div class="status-error">
                        âŒ å‘ç°å¯¹é½è¯¯å·®<br>
                        <small>è¯·æ£€æŸ¥æ§åˆ¶å°è¯¦ç»†ä¿¡æ¯</small>
                    </div>
                `;
            }
        }
        
        /**
         * åˆ‡æ¢çº¿æ¡†æ¨¡å¼
         */
        function toggleWireframe() {
            if (!gypsumCyclone) return;
            
            isWireframe = !isWireframe;
            
            gypsumCyclone.getGroup().traverse((child) => {
                if (child.isMesh) {
                    child.material.wireframe = isWireframe;
                }
            });
        }
        
        /**
         * é‡ç½®è§†è§’
         */
        function resetView() {
            camera.position.set(8, 6, 8);
            controls.target.set(0, 2, 0);
            controls.update();
        }
        
        /**
         * çª—å£å¤§å°è°ƒæ•´
         */
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        /**
         * æ¸²æŸ“å¾ªç¯
         */
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
