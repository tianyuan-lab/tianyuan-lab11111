<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±‹è„Šå¼é™¤é›¾å™¨æµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            overflow: hidden;
        }
        #container {
            width: 100vw;
            height: 100vh;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            max-width: 300px;
        }
        #info h3 {
            margin: 0 0 10px 0;
            color: #00ff88;
        }
        #info p {
            margin: 5px 0;
            line-height: 1.4;
        }
        .highlight {
            color: #ffff00;
            font-weight: bold;
        }
        .success {
            color: #00ff88;
        }
        .enhanced {
            color: #ff4500;
        }
        .micro {
            color: #ff1493;
        }
        #debug {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1001;
            max-width: 400px;
            max-height: 50vh;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }
        #debug h4 {
            margin: 0 0 10px 0;
            color: #00ffff;
        }
        .error {
            color: #ff4444;
        }
        .warning {
            color: #ffaa00;
        }
        .info {
            color: #44ff44;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="info">
        <h3>ğŸ­ å±‹è„Šå¼é™¤é›¾å™¨æµ‹è¯•</h3>
        <p><span class="highlight">é™¤é›¾å™¨ç±»å‹:</span> <span class="success">å±‹è„Šå¼é™¤é›¾å™¨</span></p>
        <p><span class="highlight">é™¤é›¾æ¿ç»“æ„:</span> äººå­—å½¢ï¼ˆ30Â°è§’ï¼‰</p>
        <p><span class="highlight">é™¤é›¾æ•ˆç‡:</span> >99.8%</p>
        <p><span class="highlight">å‹åŠ›é™:</span> <80 Pa</p>
        <p><span class="enhanced">å¢å¼ºå‹å†²æ´—:</span> ä¸‰å±‚å†²æ´—ç³»ç»Ÿ</p>
        <p><span class="micro">æ¿é—´å†²æ´—:</span> 32ä¸ªå¾®å‹å–·å˜´</p>
        <p><span class="highlight">æ”¯æ’‘ç»“æ„:</span> ä¸­å¤®è¾å°„æ¢ + ç¯å½¢è¿æ¥</p>
        <p style="margin-top: 10px; color: #87ceeb;">
            é¼ æ ‡å·¦é”®æ‹–æ‹½æ—‹è½¬<br>
            é¼ æ ‡æ»šè½®ç¼©æ”¾<br>
            å³é”®æŸ¥çœ‹å†…éƒ¨ç»“æ„
        </p>
    </div>
    
    <div id="debug">
        <h4>ğŸ”§ è°ƒè¯•ä¿¡æ¯</h4>
        <div id="debugContent">æ­£åœ¨åˆå§‹åŒ–...</div>
    </div>

    <!-- Three.js - ä½¿ç”¨æ›´ç¨³å®šçš„CDN -->
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <!-- è½¨é“æ§åˆ¶å™¨ -->
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- å¼•å…¥è„±ç¡«å¡”ç±» -->
    <script src="js/NaNValidator.js"></script>
    <script src="js/DesulfurizationTower.js"></script>

    <script>
        let scene, camera, renderer, controls;
        let tower;
        let debugContent;
        
        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function debugLog(message, type = 'info') {
            console.log(message);
            if (!debugContent) {
                debugContent = document.getElementById('debugContent');
            }
            if (debugContent) {
                const timeStamp = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
                debugContent.innerHTML += `<div class="${className}">[${timeStamp}] ${message}</div>`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }
        
        // åˆå§‹åŒ–3Dåœºæ™¯
        function init() {
            debugLog('=== åˆå§‹åŒ–å±‹è„Šå¼é™¤é›¾å™¨æµ‹è¯•åœºæ™¯ ===');
            
            try {
                // æ£€æŸ¥Three.jsæ˜¯å¦åŠ è½½
                if (typeof THREE === 'undefined') {
                    debugLog('Three.js åº“æœªåŠ è½½', 'error');
                    return;
                }
                debugLog('âœ… Three.js åº“å·²åŠ è½½');
                
                // åˆ›å»ºåœºæ™¯
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x87CEEB);
                debugLog('âœ… åœºæ™¯åˆ›å»ºå®Œæˆ');
                
                // åˆ›å»ºç›¸æœº
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(50, 30, 50);
                debugLog('âœ… ç›¸æœºåˆ›å»ºå®Œæˆ');
                
                // åˆ›å»ºæ¸²æŸ“å™¨
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.getElementById('container').appendChild(renderer.domElement);
                debugLog('âœ… æ¸²æŸ“å™¨åˆ›å»ºå®Œæˆ');
                
                // æ£€æŸ¥è½¨é“æ§åˆ¶å™¨
                if (typeof THREE.OrbitControls === 'undefined') {
                    debugLog('OrbitControls æœªåŠ è½½', 'warning');
                } else {
                    // æ·»åŠ è½¨é“æ§åˆ¶å™¨
                    controls = new THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.05;
                    controls.maxDistance = 200;
                    controls.minDistance = 10;
                    debugLog('âœ… è½¨é“æ§åˆ¶å™¨åˆ›å»ºå®Œæˆ');
                }
                
                // æ·»åŠ å…‰ç…§
                setupLighting();
                debugLog('âœ… å…‰ç…§è®¾ç½®å®Œæˆ');
                
                // åˆ›å»ºè„±ç¡«å¡”ï¼ˆä¸€çº§å¡”ï¼ŒåŒ…å«å±‹è„Šå¼é™¤é›¾å™¨ï¼‰
                createTowerWithRidgeDemister();
                
                // å¼€å§‹æ¸²æŸ“å¾ªç¯
                animate();
                debugLog('âœ… æ¸²æŸ“å¾ªç¯å·²å¯åŠ¨');
                
                debugLog('ğŸ‰ å±‹è„Šå¼é™¤é›¾å™¨æµ‹è¯•åœºæ™¯åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                debugLog('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        function setupLighting() {
            // ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            // ä¸»å…‰æº
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(50, 50, 50);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // è¡¥å……å…‰æº
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
            fillLight.position.set(-50, 30, -50);
            scene.add(fillLight);
        }
        
        async function createTowerWithRidgeDemister() {
            debugLog('=== å¼€å§‹åˆ›å»ºå±‹è„Šå¼é™¤é›¾å™¨è„±ç¡«å¡” ===');
            
            // æ£€æŸ¥å¿…è¦çš„åº“æ˜¯å¦åŠ è½½
            if (typeof THREE === 'undefined') {
                debugLog('Three.js åº“æœªåŠ è½½', 'error');
                return;
            }
            
            if (typeof DesulfurizationTower === 'undefined') {
                debugLog('DesulfurizationTower ç±»æœªåŠ è½½', 'error');
                return;
            }
            
            debugLog('âœ… æ‰€æœ‰å¿…è¦çš„åº“å·²åŠ è½½');
            
            try {
                // åˆ›å»ºä¸€çº§å¡”é…ç½®ï¼ˆç®€åŒ–é…ç½®ï¼Œç¡®ä¿ç¨³å®šæ€§ï¼‰
                const towerConfig = {
                    name: 'ä¸€çº§è„±ç¡«å¡”ï¼ˆå±‹è„Šå¼é™¤é›¾å™¨ï¼‰',
                    height: 30,
                    upperRadius: 8,
                    middleRadius: 8,
                    lowerRadius: 12,
                    position: { x: 0, y: 0, z: 0 },
                    hasTrays: true,
                    hasWetESP: false
                };
                
                debugLog('ğŸ“ å¡”é…ç½®: ' + JSON.stringify(towerConfig, null, 2));
                
                // åˆ›å»ºè„±ç¡«å¡”å®ä¾‹
                debugLog('ğŸ—ï¸ æ­£åœ¨åˆ›å»ºå¡”å®ä¾‹...');
                tower = new DesulfurizationTower(towerConfig);
                
                // æ£€æŸ¥å®ä¾‹æ˜¯å¦æˆåŠŸåˆ›å»º
                if (!tower) {
                    throw new Error('å¡”å®ä¾‹åˆ›å»ºå¤±è´¥');
                }
                
                debugLog('âœ… å¡”å®ä¾‹åˆ›å»ºæˆåŠŸ');
                debugLog('ğŸ”„ ç­‰å¾…åˆå§‹åŒ–å®Œæˆ...');
                
                // ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
                await tower.waitForInitialization();
                
                debugLog('âœ… å¡”åˆå§‹åŒ–å®Œæˆ');
                debugLog('ğŸ“¦ å¡”ç»„ä»¶: ' + (tower.group ? 'å¤–éƒ¨ç»„ä»¶å·²åˆ›å»º' : 'å¤–éƒ¨ç»„ä»¶æœªåˆ›å»º'));
                debugLog('ğŸ“¦ å†…éƒ¨ç»„ä»¶: ' + (tower.interiorGroup ? 'å†…éƒ¨ç»„ä»¶å·²åˆ›å»º' : 'å†…éƒ¨ç»„ä»¶æœªåˆ›å»º'));
                
                // æ·»åŠ åˆ°åœºæ™¯
                if (tower.group) {
                    scene.add(tower.group);
                    debugLog('âœ… å¤–éƒ¨ç»„ä»¶å·²æ·»åŠ åˆ°åœºæ™¯ (å­ç»„ä»¶: ' + tower.group.children.length + 'ä¸ª)');
                }
                
                if (tower.interiorGroup) {
                    scene.add(tower.interiorGroup);
                    debugLog('âœ… å†…éƒ¨ç»„ä»¶å·²æ·»åŠ åˆ°åœºæ™¯ (å­ç»„ä»¶: ' + tower.interiorGroup.children.length + 'ä¸ª)');
                }
                
                // æ˜¾ç¤ºå†…éƒ¨ç»“æ„
                if (tower.showInterior) {
                    tower.showInterior();
                    debugLog('âœ… æ˜¾ç¤ºå†…éƒ¨ç»“æ„');
                }
                
                // è¾“å‡ºç»„ä»¶ç»Ÿè®¡
                if (tower.components) {
                    debugLog('ğŸ“Š å¡”å†…ç»„ä»¶åˆ—è¡¨:');
                    for (const [name, component] of tower.components) {
                        debugLog(`  - ${name}: ${component.children ? component.children.length : 0} ä¸ªå­ç»„ä»¶`);
                    }
                }
                
                // æ£€æŸ¥é™¤é›¾å™¨
                const demisters = tower.components ? tower.components.get('demisters') || tower.components.get('ridgeDemisters') : null;
                if (demisters) {
                    debugLog('ğŸ”§ å±‹è„Šå¼é™¤é›¾å™¨åˆ†æ:');
                    debugLog('- åç§°: ' + demisters.name);
                    debugLog('- å­ç»„ä»¶æ•°é‡: ' + demisters.children.length);
                    
                    // ç»Ÿè®¡ä¸åŒç±»å‹çš„ç»„ä»¶
                    let ridgePlateCount = 0;
                    let washingInterfaceCount = 0;
                    
                    demisters.traverse((child) => {
                        if (child.name && child.name.includes('ridge_plate')) {
                            ridgePlateCount++;
                        }
                        if (child.name && child.name.includes('ridge_washing_interface')) {
                            washingInterfaceCount++;
                        }
                    });
                    
                    debugLog(`  âœ“ äººå­—å½¢é™¤é›¾æ¿: ${ridgePlateCount}ä¸ª`);
                    debugLog(`  âœ“ å†²æ´—æ¥å£: ${washingInterfaceCount}ä¸ª`);
                } else {
                    debugLog('âš ï¸ æœªæ‰¾åˆ°é™¤é›¾å™¨ç»„ä»¶', 'warning');
                }
                
                debugLog('ğŸ‰ å±‹è„Šå¼é™¤é›¾å™¨è„±ç¡«å¡”åˆ›å»ºå®Œæˆï¼');
                
            } catch (error) {
                debugLog('âŒ åˆ›å»ºå±‹è„Šå¼é™¤é›¾å™¨è„±ç¡«å¡”å¤±è´¥: ' + error.message, 'error');
                debugLog('è¯¦ç»†é”™è¯¯ä¿¡æ¯: ' + error.stack, 'error');
                console.error('å®Œæ•´é”™è¯¯:', error);
                
                // å°è¯•åˆ›å»ºç®€å•çš„æµ‹è¯•å‡ ä½•ä½“
                debugLog('ğŸ”§ å°è¯•åˆ›å»ºç®€å•æµ‹è¯•å‡ ä½•ä½“...');
                try {
                    const testGeometry = new THREE.BoxGeometry(5, 5, 5);
                    const testMaterial = new THREE.MeshPhongMaterial({ color: 0xff0000 });
                    const testMesh = new THREE.Mesh(testGeometry, testMaterial);
                    testMesh.position.set(0, 5, 0);
                    scene.add(testMesh);
                    debugLog('âœ… çº¢è‰²æµ‹è¯•ç«‹æ–¹ä½“å·²æ·»åŠ åˆ°åœºæ™¯');
                    
                    // æ·»åŠ ç»¿è‰²åœ†æŸ±ä½“
                    const cylinderGeometry = new THREE.CylinderGeometry(2, 2, 10, 32);
                    const cylinderMaterial = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
                    const cylinderMesh = new THREE.Mesh(cylinderGeometry, cylinderMaterial);
                    cylinderMesh.position.set(8, 5, 0);
                    scene.add(cylinderMesh);
                    debugLog('âœ… ç»¿è‰²æµ‹è¯•åœ†æŸ±ä½“å·²æ·»åŠ åˆ°åœºæ™¯');
                    
                } catch (testError) {
                    debugLog('âŒ æµ‹è¯•å‡ ä½•ä½“åˆ›å»ºä¹Ÿå¤±è´¥: ' + testError.message, 'error');
                }
            }
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            if (controls) {
                controls.update();
            }
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }
        
        // çª—å£å¤§å°è°ƒæ•´
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        window.addEventListener('resize', onWindowResize);
        
        // å³é”®åˆ‡æ¢è§†å›¾
        document.addEventListener('contextmenu', (event) => {
            event.preventDefault();
            if (tower) {
                tower.toggleInteriorView();
                console.log('åˆ‡æ¢è§†å›¾æ¨¡å¼:', tower.isInteriorView ? 'å†…éƒ¨è§†å›¾' : 'å¤–éƒ¨è§†å›¾');
            }
        });
        
        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (event) => {
            if (!tower) return;
            
            switch(event.key.toLowerCase()) {
                case 'i':
                    tower.showInterior();
                    console.log('æ˜¾ç¤ºå†…éƒ¨ç»“æ„');
                    break;
                case 'o':
                    tower.hideInterior();
                    console.log('éšè—å†…éƒ¨ç»“æ„');
                    break;
                case 'w':
                    tower.toggleWireframeMode();
                    console.log('åˆ‡æ¢çº¿æ¡†æ¨¡å¼');
                    break;
                case 'r':
                    // é‡ç½®ç›¸æœºä½ç½®
                    camera.position.set(50, 30, 50);
                    controls.target.set(0, 15, 0);
                    console.log('é‡ç½®è§†è§’');
                    break;
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
        
        console.log('å±‹è„Šå¼é™¤é›¾å™¨æµ‹è¯•ç³»ç»Ÿå·²åŠ è½½');
        console.log('å¿«æ·é”®: I-æ˜¾ç¤ºå†…éƒ¨, O-éšè—å†…éƒ¨, W-çº¿æ¡†æ¨¡å¼, R-é‡ç½®è§†è§’');
    </script>
</body>
</html>